<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>电影 - 影乐宝</title>
    <link rel="stylesheet" type="text/css" href="/static/css/movie_detail.css">
</head>
<body>
<div th:replace="header::header"></div>
<div class="content">
    <div class="body-bg"></div>
    <div class="container">
        <!-- 电影信息栏 -->
        <div class="movie-info-bar clearboth">
            <div class="movie-poster">
                <img th:src="@{/static/image/{image}(image=${movie.image})}" th:alt="${movie.title}">
            </div>
            <div class="movie-info">
                <p th:text="${movie.title}" class="movie-name-zh"></p>
                <p class="movie-name-ods">副标题（待完善）</p>
                <ul>
                    <li>
                        <p>上映时间：<span th:text="${#dates.format(movie.year, 'yyyy年MM月dd日')}"></span></p>
                    </li>
                    <li>
                        <p>导演：<span>导演（待完善）</span></p>
                        <p>地区：<span th:text="${movie.region}"></span></p>
                    </li>
                    <li>
                        <p>主演：<span th:text="${movie.actor}"></span></p>
                    </li>
                    <li>
                        <p>题材：<span th:text="${movie.genre}"></span></p>
                    </li>
                    <li>
                        <p>类型：<span th:text="${movie.type}"></span></p>
                        <p>片长：<span>时长（待完善）</span></p>
                    </li>
                    <li>
                        <p class="movie-profile">简介：<span th:text="${movie.description}"></span>
                        </p>
                    </li>
                </ul>
                <div class="movie-wish-grade-btn clearboth">
                    <a class="movie-wish-btn flexcenter fl" th:href="@{/page/watch/{mid}(mid=${movie.mid})}">
                        <i></i>
                        <span>立即观看</span>
                    </a>
                    <a class="movie-grade-btn flexcenter fl">
                        <i></i>
                        <span>评分</span>
                    </a>
                </div>
            </div>
            <div class="movie-grade-box">
                <div class="grade-box">
                    <b id="rating" th:text="${movie.rating}" hidden></b>
                    <b><span id="integer"></span><sup>.</sup><sup id="decimal"></sup></b>
                    <p>总分：10</p>
                </div>
                <ul>
                    <li>
                        <p>评分：<span th:text="${movie.ratingCount}"></span>人</p>
                    </li>
                    <li>
                        <p>热点：<span th:text="${movie.popularity}"></span>万</p>
                    </li>
                </ul>
            </div>
        </div>
        <!-- 电影主要栏 -->
        <div class="movie-main-container clearboth">
            <!-- 左边 -->
            <div class="main-content">
                <div class="tab-subtitle">
                    <a>影评</a>
                </div>
                <div class="wrapper">
                    <textarea id="tx" placeholder="发一条友善的评论" rows="2" maxlength="200"></textarea>
                    <button>发布</button>
                </div>
                <div class="wrapper">
                    <span class="total">0/200字</span>
                </div>
                <div class="list">
                    <div class="item">
                        <i class="avatar"></i>
                        <div class="info">
                            <p class="name">张三</p>
                            <p class="text">这部片子真的太让人感动了吧！</p>
                            <p class="time">2022-10-10 20:29:21</p>
                        </div>
                    </div>
                </div>
            </div>
            <!-- 右边 -->
        </div>
    </div>
</div>

<div th:replace="footer::footer"></div>
<div id="toTop"></div>

<script type="text/javascript" src="/static/js/main.js"></script>
<script src="/static/plugin/jquery/jquery-3.7.1.js"></script>
<script type="text/javascript">

    //获取元素
    const tx = document.querySelector('#tx')
    const button = document.querySelector('.wrapper button')
    const text = document.querySelector('.text')
    const time = document.querySelector('.time')
    const list = document.querySelector('.list')
    const total = document.querySelector('.total')
    const rating = document.querySelector('#rating')

    // 将浮点数整数和小数部分分离
    function splitDecimal(value) {
        var parts = value.toString().split('.');
        var integerPart = parseInt(parts[0], 10);
        var decimalPart = (parts.length > 1) ? parseFloat('0.' + parts[1]).toFixed(1) * 10 : 0;
        // 返回对象包含整数部分和小数部分
        return {integer: integerPart, decimal: decimalPart};
    }

    window.onload = function () {
        initPublic();
        initScrollToTop();

        var value = splitDecimal(rating.innerText);
        $('#integer').text(value.integer);
        $('#decimal').text(value.decimal);
    };

    //函数功能：发布评论
    function fabu() {
        //检测用户输入的内容左右两端是否带有空格，若有空格，发布时自动取消左右两端的空格
        //若用户发布的内容为空，则自动取消该条评论的发送，并弹出提示框：请勿发送空白评论！
        if (tx.value.trim() === '') {
            tx.value = ''
            total.innerHTML = '0/200字'
            alert('请勿发送空白评论！')
            return
        }

        //创建新的元素节点
        const div = document.createElement('div')

        //修改元素节点的内容
        div.className = 'item'
        div.innerHTML = `
            <i class="avatar"></i>
            <div class="info">
                <p class="name">username</p>
                <p class="text">${tx.value}</p>
                <p class="time">${new Date().toLocaleString()}</p>
            </div>
            `

        //清空用户输入的内容
        tx.value = ''
        total.innerHTML = `${tx.value.length}/200字`

        //将用户输入的内容追加到评论区里
        list.append(div)
    }

    //鼠标点击发布，调用发布函数
    button.addEventListener('click', () => {
        fabu()
    })

    // 键盘按下Enter，调用发布函数
    tx.addEventListener('keyup', e => {
        if (e.key === 'Enter') fabu()
    })

    //输入框获得焦点，右下角自动显示字数
    tx.addEventListener('focus', function () {
        total.style.opacity = 1
    })

    //输入框失去焦点，右下角字数显示自动消失
    tx.addEventListener('blur', function () {
        total.style.opacity = 0
    })

    //用户输入时，实时显示输入字数
    tx.addEventListener('input', () => {
        total.innerHTML = `${tx.value.length}/200字`
    })
</script>
</body>

</html>